# azooKeyの辞書について

## azooKeyの辞書生成パイプラインの基礎

azooKeyでは自前で構築した辞書生成パイプラインを内部的に運用しており、これを用いて辞書を更新しています。

辞書生成パイプラインには様々な機能があります。最も基本的な機能は以下の2つです。

* 日本語データを機械的に形態素解析（単語分割）して、それぞれの文を構成する単語と読み、品詞などを得る
* 単語の出現回数や、品詞の繋がり方を統計的に解析し、辞書の重みデータを構築する

例えば「azooKeyでは自前で構築した辞書生成パイプラインを内部的に運用してます」という文章を形態素解析すると、以下のような出力が得られます。

```
azooKeyでは自前で構築した辞書生成パイプラインを内部的に運用してます。
azooKey	名詞,固有名詞,一般,*,*,*,azooKey,アズーキー,アズーキー,azooKey-added
で	助詞,格助詞,一般,*,*,*,で,デ,デ
は	助詞,係助詞,*,*,*,*,は,ハ,ワ
自前	名詞,一般,*,*,*,*,自前,ジマエ,ジマエ
で	助詞,格助詞,一般,*,*,*,で,デ,デ
構築	名詞,サ変接続,*,*,*,*,構築,コウチク,コーチク
し	動詞,自立,*,*,サ変・スル,連用形,する,シ,シ
た	助動詞,*,*,*,特殊・タ,基本形,た,タ,タ
辞書	名詞,一般,*,*,*,*,辞書,ジショ,ジショ
生成	名詞,サ変接続,*,*,*,*,生成,セイセイ,セイセイ
パイプライン	名詞,一般,*,*,*,*,パイプライン,パイプライン,パイプライン
を	助詞,格助詞,一般,*,*,*,を,ヲ,ヲ
内部	名詞,一般,*,*,*,*,内部,ナイブ,ナイブ
的	名詞,接尾,形容動詞語幹,*,*,*,的,テキ,テキ
に	助詞,副詞化,*,*,*,*,に,ニ,ニ
運用	名詞,サ変接続,*,*,*,*,運用,ウンヨウ,ウンヨー
し	動詞,自立,*,*,サ変・スル,連用形,する,シ,シ
て	助詞,接続助詞,*,*,*,*,て,テ,テ
ます	助動詞,*,*,*,特殊・マス,基本形,ます,マス,マス
。	記号,句点,*,*,*,*,。,。,。
EOS
```

こうした解析を大規模な日本語データに対して実施することで、「よく使われる言葉」を中心とした辞書データを完全自動で構築することができます。

### 自動生成の課題

残念ながら、この機械的な形態素解析に基づく辞書の構築は完璧ではなく、多くの不具合があります。以下に代表的なものを挙げます。

* 特定の基本的な語彙が含まれていないことがあります。最近特定した語彙では「逆走」が欠けていました。

  こうしたケースでは、形態素解析用の辞書を手動で更新します。パイプライン内部にはこの「azooKey用形態素解析の辞書」を管理するためのモジュールが存在します。

* 一部の語彙の読みは固定されてしまいます。例えば「日本」は常に「ニッポン」と読まれ、「ニホン」とは読まれなくなります。

  こうしたケースに対処するため、パイプライン内部には語彙の読みを一定確率で別の読みに置き換え、読みを「揺らす」処理を入れています。例えば「日本」は50%:50%で「ニホン」と「ニッポン」に揺れます。

* そもそも、読みが間違うことがあります。形態素解析機は意味的な判断をほとんどしないので、例えば「水を弾く」と「ピアノを弾く」の「弾く」を正しく読み分けることは困難です。

  これは比較的対処が難しい部類で、慣用表現と見なせるほど頻出のパターンは複合語化したり、上記の読み揺らし処理で対応したりまちまちです。

  根本的には「読み推定」の改善ということになり、これ単体で自然言語処理の研究になります。

* 基本的な語彙であっても、実際のデータ中の頻度は低いことがあります。典型的な例が四字熟語です。日本語データ中の「晴耕雨読」の頻度は十分に低いのですが、この単語が打てないとかなり怒られます。

  こうしたケースに対処するため、「これは絶対に頻度がどれだけ低くても絶対に辞書に含める」という語彙を「ベース辞書」として持っています。現在のベース辞書は[SudachiDict](https://github.com/WorksApplications/SudachiDict)のコアデータです。

  * さらに言うと、基本的な語彙であってもベース辞書から漏れていることがあります。このケースでは内部で管理しているベース辞書に対するパッチを更新します。

* 固有名詞は増減が激しく、トラッキングが難しい傾向にあります。

  パイプラインではWikipediaのアクセス数データをもとにした「最近注目度の高い人名」データを定期的に構築しており、人名についてはこの仕組みを用いてなるべく最新のものを捉えられるように努力しています。

### 辞書の設計思想

azooKeyのパイプラインは、 @ensan-hcl が個人で持続的に開発を行えることに重点を置いています。この要件を満たすため、「**データ分布に忠実な自動生成を軸に、必要最小限の人手で補正する**」という方針をとっています。辞書の人力修正などは基本的に補助的な位置づけです。

辞書に採録する語彙の判断基準についても、標準化や明確化をするつもりはありません。「なぜこの単語が載っていないのか」という質問すべてに真面目に答えていたら何もできないからです。そのような誠実さは現在の規模のazooKeyでは実現できません。したがって、辞書については開発者の独断と偏見で語彙が選ばれている、と考えてください。

ただし、ユーザフィードバックはazooKeyにおいて非常に重要です。フィードバックを得ることで開発者が気づいていなかった問題を検出し、対処することができます。

## フィードバックの処理

v2.4時点のazooKeyでは、大きく3種類の経路で変換に関する問題を収集しています。

* **アプリ内「誤った変換を報告」**

  フルアクセスが有効な場合、候補を長押しすると誤変換と思しきものを報告することができます。この機能を用いて報告される誤変換が1年あたり1000件程度あります。

* **アプリ内「この単語をシェア」**

  ユーザ辞書の編集、または変換候補の追加申請フォームから、特定の単語の辞書への申請をリクエストすることができます。v2.4.1以降ではこの申請は[GitHubレポジトリ](https://github.com/azooKey/azooKey_hotfix_dictionary_storage)に自動で紐付きます。こちらも1年あたり800件程度あります。

* **SNSや口頭のフィードバック**

  各種SNSおよびDiscordコミュニティで得られる情報に対応します。

このようなフィードバックに対して、開発サイドでは一般に次のような処理が必要になります。

* **分類**

  寄せられた情報が再現可能かどうか、期待される挙動は何なのか、などを分類します。

* **優先順位付け**

  すべての問題に対処することはリソース上不可能ですから、優先的に対処すべきと考えられるフィードバックを優先的に処理します。ここに明確な判断基準はありませんが、直感的には多くのユーザが直面する可能性がある問題（頻度の高い語彙や流行している言葉）が優先されると考えてください。ただし開発側は人間なのでめんどくさいやつは後回しにします。

* **分析**

  問題がなぜ発生したのかを検討します。例えば「逆走」のケースではベース辞書へのパッチを作る前に、形態素解析用辞書の語彙を更新すべきです。あるいは「米津玄師」に「よねずけんし」を追加せよ、というリクエストについては、「づ」を「ず」に置き換えた大量のエントリを作るのではなく、変換エンジン側で「ず」と「づ」に関する厳密性を緩められないか検討するべきです。

  一般に「辞書レベルで対処すべき問題かどうか」か重要な問題であり、**辞書項目を増やすことでアドホックに対処するよりも、問題を放置してより根本的な対処への圧を残しておく**、といった判断もあります。

* **対処**

  上で述べた「対処」が可能である問題であれば、対処を行い、次のバージョンで修正をリリースします。

  ただし、v2.4以降では「ホットフィックス辞書」が内部的に導入されたため、軽微な変更についてはこれを経由して行うことも可能です。詳細は以下で述べます。

### ホットフィックス辞書

ホットフィックス辞書は以下のレポジトリで管理されているデータです。このデータはazooKey側でダウンロードされ、ユーザ辞書に暗黙に追加されることで標準辞書に対するパッチとして機能します。

https://github.com/azooKey/azooKey_hotfix_dictionary_storage

それぞれのユーザにおいて、ホットフィックス辞書は次のような条件で更新されます。

* ユーザが本体アプリを開いた瞬間であり、かつ前回の更新から1日以上経過している場合

重要なこととしては、**ユーザがキーボードを開いただけではこの処理は行われません**。したがってazooKeyをキーボードとしてしか使っていないユーザの場合、ホットフィックスは適用されないことに注意が必要です。

ホットフィックス辞書はネットワークを経由して送信し、ユーザ辞書に紐付ける都合上、おもに高度に優先度が高く、かつ軽微な（加算的な）変更で済む場合に限って利用します。ホットフィックス辞書に10000件のエントリが追加されることはなく、そのような変更は本体アプリの更新に合わせて行うべきです。したがって、本体辞書は更新すべきだがホットフィックス辞書で対処するほどではない、という判断もありえます。

## 今後の方向性

現在のazooKeyのエコシステムに欠落しているのは、**ユーザのフィードバックをシステマチックに収集・解析し、開発者の労力を割かずに自動的に修正する仕組み**であると考えています。この方向で仕組みを整えていくことで、現状よりも安定的、継続的な辞書の更新が可能になる可能性があり、今後検討していきたい点です。